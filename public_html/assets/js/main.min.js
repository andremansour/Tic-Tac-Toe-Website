// Current Mode: 1 is AI, 0 is PvP, 2 is Multiplayer
var curMode = 1
// The symbol Player 1 is using
var ourSymbol = "x"
var ourColor = "red"
var moveCount = 0
var gameID = false
var allowWaitForMove = true

// For Multiplayer
var lastMove = "-1"

var Player1Symbol = "x"

var difficulty = "easy"

var blankImg = `/assets/img/empty.png`

var Img_00
var Img_01
var Img_02
var Img_10
var Img_11
var Img_12
var Img_20
var Img_21
var Img_22

$(document).ready(() => {
    Img_00 = $(`img[data-cell="00"]`)
    Img_01 = $(`img[data-cell="01"]`)
    Img_02 = $(`img[data-cell="02"]`)
    Img_10 = $(`img[data-cell="10"]`)
    Img_11 = $(`img[data-cell="11"]`)
    Img_12 = $(`img[data-cell="12"]`)
    Img_20 = $(`img[data-cell="20"]`)
    Img_21 = $(`img[data-cell="21"]`)
    Img_22 = $(`img[data-cell="22"]`)
})

var didGameEnd
var whoWon = 0

function RestartGame() {
    $('img.cell').each(k => {
        $($('img.cell')[k]).attr("src", blankImg)
        $($('img.cell')[k]).parent().removeClass("bg-warning")
        $($('img.cell')[k]).parent().removeClass("bg-success")
        $($('img.cell')[k]).parent().removeClass("bg-danger")
        $($('img.cell')[k]).parent().addClass("bg-light")
    })
    moveCount = 0
    didGameEnd = false
    whoWon = 0
}

function checkGameWon() {
    var theirSymbol = "x"
    if (ourSymbol == "x")
        theirSymbol = "o"
    var theirColor = "red"
    if (ourColor == "red")
        theirColor = "black"

    // Vertical
    for (let col = 0; col < 3; col++) {
        // Player 1
        var Player1Spots = 0
        for (let pos = 0; pos < 3; pos++) {
            if ($(`img[data-cell="${pos}${col}"]`).attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`)
                Player1Spots++
        }
        // Player 2
        var Player2Spots = 0
        for (let pos = 0; pos < 3; pos++) {
            if ($(`img[data-cell="${pos}${col}"]`).attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`)
                Player2Spots++
        }

        // Do game end
        if (Player1Spots == 3) {
            didGameEnd = true
            whoWon = 1

            // Highlight spots
            for (let pos = 0; pos < 3; pos++) {
                $(`img[data-cell="${pos}${col}"]`).parent().removeClass("bg-light")
                $(`img[data-cell="${pos}${col}"]`).parent().addClass("bg-success")
            }
        } else if (Player2Spots == 3) {
            didGameEnd = true
            whoWon = 2

            // Highlight spots
            for (let pos = 0; pos < 3; pos++) {
                $(`img[data-cell="${pos}${col}"]`).parent().removeClass("bg-light")
                $(`img[data-cell="${pos}${col}"]`).parent().addClass("bg-danger")
            }
        }
    }
    // Horizontal
    for (let row = 0; row < 3; row++) {
        // Player 1
        var Player1Spots = 0
        for (let pos = 0; pos < 3; pos++) {
            if ($(`img[data-cell="${row}${pos}"]`).attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`)
                Player1Spots++
        }
        // Player 2
        var Player2Spots = 0
        for (let pos = 0; pos < 3; pos++) {
            if ($(`img[data-cell="${row}${pos}"]`).attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`)
                Player2Spots++
        }

        // Do game end
        if (Player1Spots == 3) {
            didGameEnd = true
            whoWon = 1

            // Highlight spots
            for (let pos = 0; pos < 3; pos++) {
                $(`img[data-cell="${row}${pos}"]`).parent().removeClass("bg-light")
                $(`img[data-cell="${row}${pos}"]`).parent().addClass("bg-success")
            }
        } else if (Player2Spots == 3) {
            didGameEnd = true
            whoWon = 2

            // Highlight spots
            for (let pos = 0; pos < 3; pos++) {
                $(`img[data-cell="${row}${pos}"]`).parent().removeClass("bg-light")
                $(`img[data-cell="${row}${pos}"]`).parent().addClass("bg-danger")
            }
        }
    }
    // Diagonal 1 - Player 1
    if (Img_20.attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png` && Img_11.attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png` && Img_02.attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`) {
        // Highlight spots
        $(`img[data-cell="20"]`).parent().removeClass("bg-light")
        $(`img[data-cell="20"]`).parent().addClass("bg-success")
        $(`img[data-cell="11"]`).parent().removeClass("bg-light")
        $(`img[data-cell="11"]`).parent().addClass("bg-success")
        $(`img[data-cell="02"]`).parent().removeClass("bg-light")
        $(`img[data-cell="02"]`).parent().addClass("bg-success")
        whoWon = 1
        didGameEnd = true
    }
    // Diagonal 1 - Player 2
    if (Img_20.attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png` && Img_11.attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png` && Img_02.attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`) {
        $(`img[data-cell="20"]`).parent().removeClass("bg-light")
        $(`img[data-cell="20"]`).parent().addClass("bg-danger")
        $(`img[data-cell="11"]`).parent().removeClass("bg-light")
        $(`img[data-cell="11"]`).parent().addClass("bg-danger")
        $(`img[data-cell="02"]`).parent().removeClass("bg-light")
        $(`img[data-cell="02"]`).parent().addClass("bg-danger")
        whoWon = 2
        didGameEnd = true
    }
    // Diagonal 2 - Player 1
    if (Img_00.attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png` && Img_11.attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png` && Img_22.attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`) {
        // Highlight spots
        $(`img[data-cell="00"]`).parent().removeClass("bg-light")
        $(`img[data-cell="00"]`).parent().addClass("bg-success")
        $(`img[data-cell="11"]`).parent().removeClass("bg-light")
        $(`img[data-cell="11"]`).parent().addClass("bg-success")
        $(`img[data-cell="22"]`).parent().removeClass("bg-light")
        $(`img[data-cell="22"]`).parent().addClass("bg-success")
        whoWon = 1
        didGameEnd = true
    }
    // Diagonal 2 - Player 2
    if (Img_00.attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png` && Img_11.attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png` && Img_22.attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`) {
        $(`img[data-cell="00"]`).parent().removeClass("bg-light")
        $(`img[data-cell="00"]`).parent().addClass("bg-danger")
        $(`img[data-cell="11"]`).parent().removeClass("bg-light")
        $(`img[data-cell="11"]`).parent().addClass("bg-danger")
        $(`img[data-cell="22"]`).parent().removeClass("bg-light")
        $(`img[data-cell="22"]`).parent().addClass("bg-danger")
        whoWon = 2
        didGameEnd = true
    }

    if (didGameEnd) {
        if (curMode == 1) {
            // Robot
            if (whoWon == 1) {
                // Send AJAX to server for win
                $.post("/api.php?winUpdater_")

                Swal.fire({
                    title: 'You Win!',
                    text: `Great job! Try another round.`,
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Play Again`,
                    denyButtonText: `Cancel`,
                    icon: `success`,
                }).then((result) => {
                    if (result.isConfirmed) {
                        RestartGame()
                    } else if (result.isDenied) {
                        window.location.href = "/"
                    }
                })
            } else {
                Swal.fire({
                    title: 'You Lost!',
                    text: `Do you have what it takes to win? Then do it!`,
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Play Again`,
                    denyButtonText: `Cancel`,
                    icon: `error`,
                }).then((result) => {
                    if (result.isConfirmed) {
                        RestartGame()
                    } else if (result.isDenied) {
                        window.location.href = "/"
                    }
                })
            }
        } else if (curMode == 0) {
            // PvP
            if (whoWon == 1) {
                Swal.fire({
                    title: 'Player 1 Wins!',
                    text: `Congrats, Player 1. Try another round!`,
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Play Again`,
                    denyButtonText: `Cancel`,
                    icon: `success`,
                }).then((result) => {
                    if (result.isConfirmed) {
                        RestartGame()
                    } else if (result.isDenied) {
                        window.location.href = "/"
                    }
                })
            } else {
                Swal.fire({
                    title: 'Player 2 Wins!',
                    text: `Congrats, Player 2. Try another round!`,
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Play Again`,
                    denyButtonText: `Cancel`,
                    icon: `success`,
                }).then((result) => {
                    if (result.isConfirmed) {
                        RestartGame()
                    } else if (result.isDenied) {
                        window.location.href = "/"
                    }
                })
            }
        } else if (curMode == 2) {
            $("#thinking").removeClass("d-none")
            $("#thinking").addClass("d-none")

            if (whoWon == 1) {
                // Send AJAX to server for win
                $.post("/api.php?winUpdater_")

                Swal.fire(
                    'You Win!',
                    `Great job! You did it!`,
                    `success`,
                ).then((result) => {
                    window.location.href = "/"
                })
            } else {
                Swal.fire(
                    'You Lost!',
                    `Do you have what it takes to win? Then do it!`,
                    `error`,
                ).then((result) => {
                    window.location.href = "/"
                })
            }
        }

        return
    }

    // Check if it's a draw
    var takenCount = 0
    $('img.cell').each(k => {
        if ($($('img.cell')[k]).attr("src") != blankImg)
            takenCount++
    })
    if (takenCount == 9) {
        $('img.cell').each(k => {
            $($('img.cell')[k]).parent().removeClass("bg-light")
            $($('img.cell')[k]).parent().addClass("bg-warning")
        })

        if (curMode != 2) {
            Swal.fire({
                title: `It's a Draw`,
                text: `Let's give it another shot!`,
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: `Play Again`,
                denyButtonText: `Cancel`,
                icon: `question`,
            }).then((result) => {
                if (result.isConfirmed) {
                    RestartGame()
                } else if (result.isDenied) {
                    window.location.href = "/"
                }
            })
        } else {
            Swal.fire(
                `It's a Draw`,
                `Will you play again?`,
                `question`,
            ).then((result) => {
                window.location.href = "/"
            })
        }
    }
}

function doMove(element, symbol, color) {
    element.attr("src", `/assets/img/${symbol}_${color}.png`)
    moveCount++
    checkGameWon()
}

function getRandomUnusedElement() {
    while (true) {
        var cellArray = $('img.cell')
        var cell = cellArray[Math.floor(Math.random() * cellArray.length)]

        var cellID = $(cell).attr("data-cell")
        var coords = cellID.split("")
        var y = coords[0]
        var x = coords[1]

        if ($(cell).attr("src") == blankImg)
            return $(cell)
    }
}

function findPossibleWinningMove(symbol, color) {
    var theirSymbol = "x"
    if (ourSymbol == "x")
        theirSymbol = "o"
    var theirColor = "red"
    if (ourColor == "red")
        theirColor = "black"

    // Vertical
    for (let col = 0; col < 3; col++) {
        var Player2Spots = 0
        var hasPlayer1Spot = false
        var blankSpaceElement = false
        for (let pos = 0; pos < 3; pos++) {
            if ($(`img[data-cell="${pos}${col}"]`).attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`)
                Player2Spots++
            if ($(`img[data-cell="${pos}${col}"]`).attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`)
                hasPlayer1Spot = true
            if ($(`img[data-cell="${pos}${col}"]`).attr("src") == blankImg)
                blankSpaceElement = $(`img[data-cell="${pos}${col}"]`)
        }
        if (Player2Spots == 2 && !hasPlayer1Spot)
            return blankSpaceElement
    }
    // Horizontal
    for (let row = 0; row < 3; row++) {
        var Player2Spots = 0
        var hasPlayer1Spot = false
        var blankSpaceElement = false
        for (let pos = 0; pos < 3; pos++) {
            if ($(`img[data-cell="${row}${pos}"]`).attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`)
                Player2Spots++
            if ($(`img[data-cell="${row}${pos}"]`).attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`)
                hasPlayer1Spot = true
            if ($(`img[data-cell="${row}${pos}"]`).attr("src") == blankImg)
                blankSpaceElement = $(`img[data-cell="${row}${pos}"]`)
        }
        if (Player2Spots == 2 && !hasPlayer1Spot)
            return blankSpaceElement
    }
    // Diagonal 1
    var Player2Spots = 0
    var hasPlayer1Spot = false
    var blankSpaceElement = false
    var Diagonal1Combos = [Img_20, Img_11, Img_02]
    for (let pos = 0; pos < Diagonal1Combos.length; pos++) {
        if (Diagonal1Combos[pos].attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`)
            Player2Spots++
        if (Diagonal1Combos[pos].attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`)
            hasPlayer1Spot = true
        if (Diagonal1Combos[pos].attr("src") == blankImg)
            blankSpaceElement = Diagonal1Combos[pos]
    }
    if (Player2Spots == 2 && !hasPlayer1Spot)
        return blankSpaceElement
    // Diagonal 2
    var Player2Spots = 0
    var hasPlayer1Spot = false
    var blankSpaceElement = false
    var Diagonal2Combos = [Img_22, Img_11, Img_00]
    for (let pos = 0; pos < Diagonal2Combos.length; pos++) {
        if (Diagonal2Combos[pos].attr("src") == `/assets/img/${theirSymbol}_${theirColor}.png`)
            Player2Spots++
        if (Diagonal2Combos[pos].attr("src") == `/assets/img/${ourSymbol}_${ourColor}.png`)
            hasPlayer1Spot = true
        if (Diagonal2Combos[pos].attr("src") == blankImg)
            blankSpaceElement = Diagonal2Combos[pos]
    }
    if (Player2Spots == 2 && !hasPlayer1Spot)
        return blankSpaceElement

    return false
}

function getSmartestMove(symbol, color) {
    // Be dumb based on difficulty
    switch (difficulty) {
        case "easy":
            // Have a 50% chance of making a small brain move
            if (Math.floor(Math.random() * 2) == 1)
                return getRandomUnusedElement()
            break
        case "medium":
            // Have a 30% chance of making a small brain move
            if (Math.floor(Math.random() * 11) <= 3)
                return getRandomUnusedElement()
            break
    }

    // Check for winning move possibility
    var winnerElem = findPossibleWinningMove(symbol, color)
    if (winnerElem) {
        console.log("found winning move!")
        return winnerElem
    }

    var ourImg = `/assets/img/${symbol}_${color}.png`

    var botColor = "black"
    if (color == "black")
        botColor = "red"

    // Column 1
    if (Img_00.attr("src") == ourImg && Img_10.attr("src") == ourImg && Img_20.attr("src") == blankImg)
        return Img_20
    if (Img_10.attr("src") == ourImg && Img_20.attr("src") == ourImg && Img_00.attr("src") == blankImg)
        return Img_00
    if (Img_00.attr("src") == ourImg && Img_20.attr("src") == ourImg && Img_10.attr("src") == blankImg)
        return Img_10
    // Column 2
    if (Img_01.attr("src") == ourImg && Img_11.attr("src") == ourImg && Img_21.attr("src") == blankImg)
        return Img_21
    if (Img_11.attr("src") == ourImg && Img_21.attr("src") == ourImg && Img_01.attr("src") == blankImg)
        return Img_01
    if (Img_01.attr("src") == ourImg && Img_21.attr("src") == ourImg && Img_11.attr("src") == blankImg)
        return Img_11
    // Column 3
    if (Img_02.attr("src") == ourImg && Img_12.attr("src") == ourImg && Img_22.attr("src") == blankImg)
        return Img_22
    if (Img_12.attr("src") == ourImg && Img_22.attr("src") == ourImg && Img_02.attr("src") == blankImg)
        return Img_02
    if (Img_02.attr("src") == ourImg && Img_22.attr("src") == ourImg && Img_12.attr("src") == blankImg)
        return Img_12
    // Row 1
    if (Img_00.attr("src") == ourImg && Img_01.attr("src") == ourImg && Img_02.attr("src") == blankImg)
        return Img_02
    if (Img_01.attr("src") == ourImg && Img_02.attr("src") == ourImg && Img_00.attr("src") == blankImg)
        return Img_00
    if (Img_00.attr("src") == ourImg && Img_02.attr("src") == ourImg && Img_01.attr("src") == blankImg)
        return Img_01
    // Row 2
    if (Img_10.attr("src") == ourImg && Img_11.attr("src") == ourImg && Img_12.attr("src") == blankImg)
        return Img_12
    if (Img_11.attr("src") == ourImg && Img_12.attr("src") == ourImg && Img_10.attr("src") == blankImg)
        return Img_10
    if (Img_10.attr("src") == ourImg && Img_12.attr("src") == ourImg && Img_11.attr("src") == blankImg)
        return Img_11
    // Row 3
    if (Img_20.attr("src") == ourImg && Img_21.attr("src") == ourImg && Img_22.attr("src") == blankImg)
        return Img_22
    if (Img_21.attr("src") == ourImg && Img_22.attr("src") == ourImg && Img_20.attr("src") == blankImg)
        return Img_20
    if (Img_20.attr("src") == ourImg && Img_22.attr("src") == ourImg && Img_21.attr("src") == blankImg)
        return Img_21
    // Diagonal 1
    if (Img_00.attr("src") == ourImg && Img_11.attr("src") == ourImg && Img_22.attr("src") == blankImg)
        return Img_22
    if (Img_11.attr("src") == ourImg && Img_22.attr("src") == ourImg && Img_00.attr("src") == blankImg)
        return Img_00
    if (Img_00.attr("src") == ourImg && Img_22.attr("src") == ourImg && Img_11.attr("src") == blankImg)
        return Img_11
    // Diagonal 2
    if (Img_20.attr("src") == ourImg && Img_11.attr("src") == ourImg && Img_02.attr("src") == blankImg)
        return Img_02
    if (Img_11.attr("src") == ourImg && Img_02.attr("src") == ourImg && Img_20.attr("src") == blankImg)
        return Img_20
    if (Img_20.attr("src") == ourImg && Img_02.attr("src") == ourImg && Img_11.attr("src") == blankImg)
        return Img_11

    return getRandomUnusedElement()
}

var whosTurn = 1
var waiting = false
$(document).ready(() => {
    $('#gameboard .cell').click(e => {
        if (waiting) return

        if (didGameEnd) return

        if ($(e.target).attr("src") != blankImg) return

        var theColor = "red"
        var theSymbol = "o"
        if (whosTurn == 1) {
            theColor = ourColor
            theSymbol = ourSymbol
        } else {
            if (ourColor == "red")
                theColor = "black"
            if (ourSymbol == "o")
                theSymbol = "x"
        }

        doMove($(e.target), theSymbol, theColor)

        // Multiplayer
        if (curMode == 2) {
            var move = $(e.target).attr("data-cell")
            lastMove = move
            allowWaitForMove = false
            $.get("/api.php?updateMove_=" + gameID + "&newMove=" + move, () => {
                allowWaitForMove = true
            })
            $('#thinking').removeClass("d-none")
        }

        if (didGameEnd) return

        // Switch it to Player 2 for the PvP
        if (curMode == 0) {
            whosTurn = whosTurn * -1
        }

        // Do AI move
        if (curMode == 1 && moveCount <= 8) {
            waiting = true

            $('#thinking').removeClass("d-none")

            var botSymbol = "x"
            if (ourSymbol == "x")
                botSymbol = "o"

            var theColor = "red"
            if (ourColor == "red")
                theColor = "black"

            setTimeout(() => {
                waiting = false
                $('#thinking').addClass("d-none")
                var element = getSmartestMove(ourSymbol, ourColor)
                doMove(element, botSymbol, theColor)
            }, Math.floor(Math.random() * 2000))
        }
    })

    function WhatMethod() {
        $('#symbol').fadeOut(1000)
        setTimeout(() => {
            $('#method').removeClass("d-none")
        }, 1000)
    }

    $('#pvp').click(e => {
        curMode = 0
        $('#method').fadeOut(1000)
        setTimeout(() => {
            $('#gameboard').removeClass("d-none")
            $('#gameboard').addClass("d-flex")
        }, 1000)
    })
    $('#multiplayer').click(e => {
        curMode = 2
        $('#method').fadeOut(1000)
        setTimeout(() => {
            $('#gameboard').removeClass("d-none")
            $('#gameboard').addClass("d-flex")

            $.get("/api.php?createSession_", function (id) {
                gameID = id

                var url = `${window.location.hostname}/?session=${id}&ourSymbol=${ourSymbol}&ourColor=${ourColor}`

                Swal.fire({
                    title: 'Your game session has been created!',
                    text: url,
                    icon: 'info',
                    confirmButtonText: 'Copy to Clipboard'
                }).then((result) => {
                    navigator.clipboard.writeText(url)
                })

                function checkForMove() {
                    setTimeout(function () {
                        // do a get request $.get to server to ask for move variable from SQL
                        if (allowWaitForMove) {
                            $.get("/api.php?getCurrentMove_=" + id, (move) => {
                                if (move != lastMove) {
                                    var theirSymbol = "x"
                                    if (ourSymbol == "x")
                                        theirSymbol = "o"
                                    var theirColor = "red"
                                    if (ourColor == "red")
                                        theirColor = "black"

                                    var arr = move.split("")
                                    $(`img[data-cell="${arr[0]}${arr[1]}"]`).attr("src", `/assets/img/${theirSymbol}_${theirColor}.png`)
                                    lastMove = move

                                    checkGameWon()

                                    $('#thinking').addClass("d-none")
                                }
                            })
                        }

                        checkForMove()
                    }, 1000)
                }
                checkForMove()

                $('#thinkText').html("Waiting for other player...")
                $('#thinking').removeClass("d-none")
            })

        }, 1000)
    })

    $('#robot').click(e => {
        curMode = 1
        $('#method').fadeOut(1000)
        setTimeout(() => {
            $('#difficulty').removeClass("d-none")
        }, 1000)
    })

    $('#easy').click(e => {
        difficulty = "easy"
        $('#difficulty').fadeOut(1000)
        setTimeout(() => {
            $('#gameboard').removeClass("d-none")
            $('#gameboard').addClass("d-flex")
        }, 1000)
    })
    $('#medium').click(e => {
        difficulty = "medium"
        $('#difficulty').fadeOut(1000)
        setTimeout(() => {
            $('#gameboard').removeClass("d-none")
            $('#gameboard').addClass("d-flex")
        }, 1000)
    })
    $('#hard').click(e => {
        difficulty = "hard"
        $('#difficulty').fadeOut(1000)
        setTimeout(() => {
            $('#gameboard').removeClass("d-none")
            $('#gameboard').addClass("d-flex")
        }, 1000)
    })

    $('#select_x').click(e => {
        ourSymbol = "x"
        Player1Symbol = ourSymbol
        WhatMethod()
    })
    $('#select_o').click(e => {
        ourSymbol = "o"
        Player1Symbol = ourSymbol
        WhatMethod()
    })
})